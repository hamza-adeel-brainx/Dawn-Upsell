{% layout none %}

{% for collection in product.collections %}
  {% if collection.metafields.custom.upsell_list %}
    {% assign cart_items_collection = cart_items_collection | append: collection.handle %}
    {% unless forloop.last %}
      {% assign cart_items_collection = cart_items_collection | append: ',' %}
    {% endunless %}
  {% endif %}
{% endfor %}
{% comment %}
  {% assign cart_items = cart_items | append: item.product.id %}
    {% unless forloop.last %}
      {% assign cart_items = cart_items | append: ',' %}
  {% endunless %}
{% endcomment %}

{% if cart_items_collection.size > 1 %}
  {% liquid
    assign upsellProductsList = ''
    assign upsellProductCount = 0
  %}

  {% assign cart_items_collection = cart_items_collection | split: ',' %}
  {% for collectionHandle in cart_items_collection %}
    {% assign collection = collections[collectionHandle] %}
    {% if collection.metafields.custom.upsell_list %}
      {% assign productsUpsells = collection.metafields.custom.upsell_list.value %}
      {% for productsUpsell in productsUpsells limit: 2 %}
        {{ productsUpsell.handle }}
        {% unless forloop.last %}
          ,
        {% endunless %}
      {% endfor %}
    {% endif %}
  {% endfor %}
{% endif %}
